<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NDVI Predictor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 700px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        h1 {
            text-align: center;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        select, input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .input-row .form-group {
            flex: 1;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
        }
        button:hover {
            background-color: #2980b9;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            background-color: #eaf7ea;
            border-radius: 6px;
            border-left: 5px solid #27ae60;
            display: none;
        }
        .error-msg {
            margin-top: 20px;
            padding: 15px;
            background-color: #fdeded;
            border-left: 5px solid #e74c3c;
            color: #c0392b;
            display: none;
        }
        .chart-container {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 6px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>NDVI Predictor</h1>
        
        <div class="form-group">
            <label for="region">Select Region:</label>
            <select id="region" name="region">
                <option value="north">North</option>
                <option value="south">South</option>
                <option value="east">East</option>
                <option value="west">West</option>
            </select>
        </div>
        
        <div class="form-group">
            <label>Enter Last 5 Years NDVI Values:</label>
            <div class="input-row" id="ndvi-inputs">
                <!-- Input fields will be generated by JavaScript -->
            </div>
        </div>
        
        <button id="predict-btn">Predict Next 3 Years</button>
        
        <div id="error-msg" class="error-msg"></div>
        
        <div id="result" class="result">
            <h3>Predicted NDVI Values:</h3>
            <!-- Result items will be generated by JavaScript -->
        </div>
        
        <div id="chart-container" class="chart-container">
            <canvas id="ndviChart"></canvas>
        </div>
    </div>

    <script>
        // Chart.js instance
        let ndviChart;
        
        // Sample data for each region
        const sampleData = {
            'north': [0.41, 0.44, 0.42, 0.46, 0.49],
            'south': [0.55, 0.59, 0.62, 0.60, 0.65],
            'east': [0.38, 0.42, 0.45, 0.48, 0.47],
            'west': [0.52, 0.50, 0.53, 0.57, 0.60]
        };
        
        // Generate input fields
        function generateInputFields() {
            const currentYear = new Date().getFullYear();
            const inputContainer = document.getElementById('ndvi-inputs');
            inputContainer.innerHTML = '';
            
            for (let i = 0; i < 5; i++) {
                const year = currentYear - (4 - i);
                const inputGroup = document.createElement('div');
                inputGroup.className = 'form-group';
                
                const label = document.createElement('label');
                label.setAttribute('for', `ndvi${i+1}`);
                label.textContent = `${year}:`;
                
                const input = document.createElement('input');
                input.type = 'number';
                input.id = `ndvi${i+1}`;
                input.name = `ndvi${i+1}`;
                input.step = '0.01';
                input.placeholder = 'e.g., 0.45';
                input.min = '-1';
                input.max = '1';
                
                inputGroup.appendChild(label);
                inputGroup.appendChild(input);
                inputContainer.appendChild(inputGroup);
            }
        }
        
        // Generate result sections
        function generateResultItems() {
            const currentYear = new Date().getFullYear();
            const resultContainer = document.getElementById('result');
            
            // Clear existing result items except the heading
            const heading = resultContainer.querySelector('h3');
            resultContainer.innerHTML = '';
            resultContainer.appendChild(heading);
            
            // Generate 3 result items for the next 3 years
            for (let i = 0; i < 3; i++) {
                const year = currentYear + (i + 1);
                const resultItem = document.createElement('div');
                resultItem.style.margin = '10px 0';
                
                const yearSpan = document.createElement('span');
                yearSpan.textContent = `${year}: `;
                yearSpan.style.marginRight = '10px';
                
                const valueSpan = document.createElement('span');
                valueSpan.id = `year${i+1}`;
                valueSpan.style.fontWeight = 'bold';
                valueSpan.textContent = '-';
                
                resultItem.appendChild(yearSpan);
                resultItem.appendChild(valueSpan);
                resultContainer.appendChild(resultItem);
            }
        }
        
        // Update or create chart
        function updateChart(historicalData, predictedData) {
            const ctx = document.getElementById('ndviChart').getContext('2d');
            const currentYear = new Date().getFullYear();
            
            // Prepare labels
            const labels = [];
            for (let i = -4; i <= 3; i++) {
                labels.push(currentYear + i);
            }
            
            // Data for historical and predicted values
            const historicalDataset = Array(8).fill(null);
            const predictedDataset = Array(8).fill(null);
            
            // Fill in the datasets
            for (let i = 0; i < 5; i++) {
                historicalDataset[i] = historicalData[i];
            }
            
            for (let i = 0; i < 3; i++) {
                predictedDataset[i + 5] = predictedData[i];
            }
            
            // If chart exists, destroy it
            if (ndviChart) {
                ndviChart.destroy();
            }
            
            // Create new chart
            ndviChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Historical NDVI',
                            data: historicalDataset,
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.2)',
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'Predicted NDVI',
                            data: predictedDataset,
                            borderColor: '#27ae60',
                            backgroundColor: 'rgba(39, 174, 96, 0.2)',
                            fill: true,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    scales: {
                        y: {
                            min: -0.1,
                            max: 1.0
                        }
                    },
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    }
                }
            });
            
            // Show chart container
            document.getElementById('chart-container').style.display = 'block';
        }
        
        // Event listener for prediction button
        document.getElementById('predict-btn').addEventListener('click', function() {
            // Hide previous results
            document.getElementById('result').style.display = 'none';
            document.getElementById('error-msg').style.display = 'none';
            document.getElementById('chart-container').style.display = 'none';
            
            const region = document.getElementById('region').value;
            
            // Collect NDVI values
            const ndviValues = [];
            let hasError = false;
            
            for (let i = 1; i <= 5; i++) {
                const input = document.getElementById(`ndvi${i}`);
                const value = input.value.trim() === '' ? null : parseFloat(input.value);
                
                if (value === null || isNaN(value) || value < -1 || value > 1) {
                    hasError = true;
                    break;
                }
                
                ndviValues.push(value);
            }
            
            if (hasError) {
                const errorMsg = document.getElementById('error-msg');
                errorMsg.textContent = "Please enter valid NDVI values between -1 and 1 for all fields.";
                errorMsg.style.display = 'block';
                return;
            }
            
            // Prepare form data for submission
            const formData = new FormData();
            formData.append('region', region);
            for (let i = 1; i <= 5; i++) {
                formData.append(`ndvi${i}`, document.getElementById(`ndvi${i}`).value);
            }
            
            // Send request to server
            fetch('/predict', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    // Show error message
                    const errorMsg = document.getElementById('error-msg');
                    errorMsg.textContent = data.error;
                    errorMsg.style.display = 'block';
                    return;
                }
                
                // Display results
                document.getElementById('year1').textContent = data.year1;
                document.getElementById('year2').textContent = data.year2;
                document.getElementById('year3').textContent = data.year3;
                document.getElementById('result').style.display = 'block';
                
                // Update chart
                updateChart(ndviValues, [
                    parseFloat(data.year1), 
                    parseFloat(data.year2), 
                    parseFloat(data.year3)
                ]);
            })
            .catch(error => {
                // Show error message
                const errorMsg = document.getElementById('error-msg');
                errorMsg.textContent = "Error connecting to the server. Please try again later.";
                errorMsg.style.display = 'block';
            });
        });
        
        // Auto-fill with sample data when region changes
        document.getElementById('region').addEventListener('change', function() {
            const region = this.value;
            const data = sampleData[region];
            
            if (data) {
                for (let i = 0; i < 5; i++) {
                    const input = document.getElementById(`ndvi${i+1}`);
                    if (input) {
                        input.value = data[i];
                    }
                }
            }
        });
        
        // Initialize page
        window.onload = function() {
            generateInputFields();
            generateResultItems();
            
            // Fill with default data for North region
            const region = document.getElementById('region').value;
            const data = sampleData[region];
            
            if (data) {
                for (let i = 0; i < 5; i++) {
                    const input = document.getElementById(`ndvi${i+1}`);
                    if (input) {
                        input.value = data[i];
                    }
                }
            }
        };
    </script>
</body>
</html>
